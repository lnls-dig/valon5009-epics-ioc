#!/usr/bin/env bash
	
set -u

if [ -z "$VALON_INSTANCE" ]; then
    echo "VALON_INSTANCE environment variable is not set." >&2
    exit 1
fi

export VALON_CURRENT_PV_AREA_PREFIX=VALON_${VALON_INSTANCE}_PV_AREA_PREFIX
export VALON_CURRENT_PV_DEVICE_PREFIX=VALON_${VALON_INSTANCE}_PV_DEVICE_PREFIX
export VALON_CURRENT_SERIAL_PORT=VALON_${VALON_INSTANCE}_SERIAL_PORT
export VALON_CURRENT_DEVICE_TELNET_PORT=VALON_${VALON_INSTANCE}_TELNET_PORT
# Only works with bash
export VALON_PV_AREA_PREFIX=${!VALON_CURRENT_PV_AREA_PREFIX}
export VALON_PV_DEVICE_PREFIX=${!VALON_CURRENT_PV_DEVICE_PREFIX}
export VALON_SERIAL_PORT=${!VALON_CURRENT_SERIAL_PORT}
export VALON_DEVICE_TELNET_PORT=${!VALON_CURRENT_DEVICE_TELNET_PORT}

if [ -z "${VALON_CURRENT_DEVICE_TELNET_PORT}" ]; then
    echo "TELNET port is not set." >&2
    exit 1
fi

./runProcServ.sh \
    -t "${VALON_DEVICE_TELNET_PORT}" \
    -p "${VALON_SERIAL_PORT}" \
    -P "${VALON_PV_AREA_PREFIX}" \
    -R "${VALON_PV_DEVICE_PREFIX}"

